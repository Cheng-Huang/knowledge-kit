## 背景 

- 描述现状

  iOS 端将 SDK、App 通过 candle 打包平台进行任务创建、排队、打包，根据任务的特点和语言去调度合适的打包机器进行打包。 现状是整体速度觉得较慢，还有加速空间

- 问题原因

  iOS 打包目前都是在使用旧的打包构建系统，所以在单包构建方面会慢一些；

  在 pod install 这一步，打包机使用的 1.3.1 版本的 cocoapods 版本在进行依赖分析，它本质上是操纵打包机上全局的 git 目录，由于本质如此所以没办法多包并行打包。

- 风险预警

  1. cocoapods 升级到最新版本，目前的 cocoapods 的相关的 ruby 脚本可能会有问题，没办法良好运行。
  2. 开启 Xcode 的新构建系统，可能会造成现有工程报错，没办法编译成功，需要改动。这些改动可能不只是主工程，也许是各个 SDK 自身的修改，所以会比较零散。

  

## 目标

> iOS 单包构建加速、支持多包并行打包



## 改造

#### 单包加速


New Build System/1.3.1 
New Build System/1.8.4

Legacy Build System/1.3.1
Legacy Build System/1.8.4


| App| 构建系统 |  Cocoapods 版本  | Build 结果 | 测试次数| 编译时间 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 挖财宝 | New Build System | 失败 | 1.3.1 | 1| ~ |
| 挖财宝 | New Build System | 失败 | 1.3.1 | 2| ~ |
| 挖财宝 | Legacy Build System | 成功| 1.3.1 | 1| 357.5 |
| 挖财宝 | Legacy Build System | 成功| 1.3.1 | 2| 7.2 | 

| 挖财宝 | New Build System | 失败 | 1.8.4 | 1| 320.0|
| 挖财宝 | New Build System | 失败 | 1.8.4 | 2|  7.7 |
| 挖财宝 | Legacy Build System | 成功| 1.8.4 | 1| 260.6|
| 挖财宝 | Legacy Build System | 成功| 1.8.4 | 2| 6.5 | 


经过实验数据可以看出：
- 挖财宝 App，在开启新旧构建系统，时间节省 `(608.0-345.5)/608.0 = 43.25%`
- Prism Demo App，在开启新旧构建系统，时间节省 `(-310.2)/ = %`

所以，不管是从数据层面还是迎合苹果官方的推荐做法，选择 New Build System 是正确之道。（跟着系统走，以后会带来潜在的好处）



本质上就是开启 New Build System，苹果在 WWDC 2017 中描述新构建系统的有点为：**降低构建开销，尤其可以降低大型项目的构建开销**。但是在新构建系统下现有的工程会报错。经过查看报错信息，基本都是在资源方面的错误（plist、图片等）和偶尔一些 SDK 不规范造成的问题。

苹果从 Xcode 9 开始推出了新构建系统（New Build System），并在 Xcode 10 使用其为默认构建系统来替代旧构建系统（Legacy Build System）。采用新构建系统能够减少构建时间。

简要介绍一下原理，对于旧构建系统，当我们构建一个程序的时候，会明确所需要构建的所有 Target Dependencies、Link Binary With Libraries，这些 Target 之间的依赖关系，以及这些  Target  构建的顺序。采用顺序会造成多处理器系统资源的浪费，从而表现为编译时间的浪费，解决这个问题的方式就是采用并行编译，这也是新构建系统优化的核心思想。详细了解新构建系统，探究 Xcode New Build System 对于构建速度的提升。

注意：目前我的机器升级 cocoapods 提示找不到 `coderay`. 可以运行 `sudo gem install coderay` 解决该问题。

1. SDK 中图片是通过 resource 的方式管理的，cocoapods 1.8.4 会将它打包到 `Assets.car` 和 App 主工程图片打包的结果一致，导致 Xcode 主工程报错，大体意思是说工程包含多个 **Assets.car**. 原因在于 SDK 通过 resource 管理图片，打出包所以可以使用 ``resource_bundles`` 的形式管理
   - 涉及到的 SDK：TrinityConfiguration（公共 SDK）
   - 改造点：
     注意：改变 SDK 内部修改 xcassets 文件名是无用的，Xcode 编译后查看包内容，结果还是 `Assests.car` 。
     图片使用方式改变。由之前的 **resources** 方式改为 **`resource_bundles`** 的形式。这样做有2个优点：解决了图片资源打包后造成 `Assets.car` 冲突的问题；`resource_bundles` 还可以解决图片访问速度的优化。
   - 改造成本：0.5人/日 
   - 负责人：公共平台组
2. 图片资源重复
   挖财宝工程中有些图片和 理财的 SDK `SdkFinanceHome` 里面的图片资源重名，但是内容却不一致，需要协商改动。
   
   - 涉及到的 SDK：SdkFinanceHome （理财业务线 SDK）
   - 改造点：
     有2张图片在 SdkFinanceHome SDK 内重复出现2次(形状、大小一致)。App 也存在同名的图片，图形一致、尺寸大小不一致。所以需要挖财宝业务线开发者确认，保留什么图片或者资源重命名。建议图片资源也用 **`resource_bundles`** 的形式管理
     ```ruby
     s.resource_bundles = {
     'SdkFinanceHome' => ['***/Assets/*.xcassets']
     }
     ```
   - 改造成本：0.5人/日
   - 负责人：挖财宝业务线
3. 部分 SDK 的头文件引用方式有问题
   - 涉及到的 SDK：SdkFundWax
   - 改造点：将 `FCH5AuthRouter.m` 文件中关于 NativeQS 中头文件的引入方式改变下。`#import <NQSParser.h>` 改为 `#import <NativeQS/NativeQS.h>`
     ```ruby
      "dependencies": {
         "NativeQS": "~> 1.0"
       },
     ```
   
     注意：
   
     新版本 cocoapods 中：
   
     - cocoapods 在 SDK 里面引用别的 SDK 如果 **podspec** 里面存在 **dependencies** 描述，则可以使用 `#import <NativeQS/NativeQS.h>` 或者 `#import "NativeQS.h"`；如果不存在 **dependencies** 描述，则需要使用 `#import <NativeQS/NativeQS.h>`
     - 在主工程中引用 SDK 的头文件，使用 `#import <NativeQS/NativeQS.h>`、`#import "NativeQS.h"` 都可以
   
     旧版本 cocoapods 中:
     - SDK、App 主工程都可以使用 `#import <NativeQS/NativeQS.h>`、`#import "NativeQS.h"`、`#import <NativeQS.h>`
   - 改造成本：0.3人/日
   - 负责人：挖财宝业务线
4. 部分 SDK 的使用了未在 podspec 文件中声明的依赖，在新版本 cocoapods 下会报错（某些 SDK 由于历史原因造成新版本丢失依赖描述）
   - 涉及到的 SDK：CMRCTToast
   - 改造点：
     问题基本定位是在于, App 主工程引用的 SdkBbs2 SDK 依赖了 SdkBbs2 版本(该版本的依赖描述为 `CMRCTToast (~> 0.1)` )
     历史原因： 早期在做 RN SDK 封装的时候在第一个版本的时候只有某个版本的 React Native 库，所以在 `0.1.0` 的时候依赖的描述可以看到如下的代码
     
     ```ruby
     s.dependency 'React/Core', '0.41.2'
     s.dependency 'React/RCTNetwork', '0.41.2'
     s.dependency 'React/RCTImage', '0.41.2'
     s.dependency 'React/RCTText', '0.41.2'
     s.dependency 'React/RCTWebSocket', '0.41.2'
     s.dependency 'React/RCTAnimation', '0.41.2'
     ```
     随着版本的不断迭代，在第二个版本 `0.1.1` 的时候可以看到下面的描述. 可以看到对 RN 的描述不存在了，因为当时的代码对 RN 的2个版本都做了兼容，所以 App 主工程肯定是有 RN 的库，所以索性就不在单独描述，直接随着 App 依赖的 RN 库而使用。之后的版本也是如此。
     ```ruby
     s.dependency 'CMDevice', '~> 0.1'
     ```
     所以， 将 `CMRCTToast.podspec` 中的依赖修改掉。需要兼容不同 RN SDK 的版本。
   - 改造成本：1人/日
   - 负责人：公共平台组
5. 部分 pod 的 hook 脚本会失败。
   - 涉及到的 SDK：无
   - 改造点:
      `TrinityParams.rb` 类方法 `generate_mods` 内部有段逻辑是获取 native_target，但是新版本中该方法传递的参数没有这个属性，所以方法增加了一个参数来专门处理这个问题。本地验证过。
   - 改造成本：0.5人/日
   - 负责人：公共平台组



#### 多包加速

目前不能开启多包并行的瓶颈在于打包机操作的是本地下载下来的 `.cocoapods` 文件夹，所以当一个项目操作的时候其他项目没办法操作。

CDN 提供了通过网络接口处理依赖的能力，通过网络去操作文件，文件的读写锁保护 cocoapods 官方已经做了，所以是可以多包并行打包的。

但是由于以下2个原因，我们需要自建``` CDN``` 的能力：

1. 我们的依赖存在的位置有2个，1个是私有源、1个是官方源。目前使用官方``` CDN``` 就是官方源，因为我们要并行打包，所以私有源也需要 `CDN` 化。不然难以免于多个项目进行文件的读写锁操作问题。
2. 但是``` CDN``` 跟网络的状态有关，依据所处位置附近的服务器有关系，严重依赖于外界因素，不可控。所以想拥有快速稳定的`` CDN`` 查询能力就需要自建`` CDN`` 了。

另外一个可预期的点就是自建了` CDN` ，wax SDK 发布的相关逻辑也需要修改。

目前关于 cocoapods ` CDN` 能力是否开放的开发者，正在验证...



### 

#### 接入方式

考虑到业务线 App 升级是分开的，不可能同步进行，所以需要考虑到接入计划。

- 能否提供 wax 项目指定到特定环境打包机的能力（该打包机升级了 cocoapods 版本）
- 假如没有上述能力，则考虑其他方式支持业务线自定义打包所需的 cocoapods 版本
  - 将 2个版本的 cocoapods 做成2个 Bundle 包，读取 wax 工程配置，指定某个 Bundle 
  - 假如打包机由于某些原因没办法升级 cocoapods 版本，但是某个 wax 项目又需要新版的 cocoapods 进行打包，则需要则代码上传的时候提交 `Pods` 文件夹。这样在打包机上面不需要执行 install 的操作，将本地的 Pods 目录上传上来，全部使用本地的一套。

